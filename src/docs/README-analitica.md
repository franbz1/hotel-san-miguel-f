# üìä M√≥dulo de Analytics - Hotel San Miguel

## üìã Descripci√≥n General

El m√≥dulo de Analytics proporciona an√°lisis estad√≠sticos y m√©tricas de rendimiento del hotel a trav√©s de consultas optimizadas. Incluye ocupaci√≥n hotelera, demograf√≠a de hu√©spedes, rendimiento por habitaciones, motivos de viaje, predicciones y dashboard ejecutivo.

## üîí Permisos de Acceso

**Todos los endpoints requieren autenticaci√≥n y autorizaci√≥n:**
- **Roles permitidos:** `ADMINISTRADOR` y `CAJERO`
- **Excepci√≥n:** Endpoints de forecast y dashboard son **solo para ADMINISTRADOR**
- **Implementaci√≥n:** Decorador `@Auth(Role.ADMINISTRADOR, Role.CAJERO)` a nivel de clase + `@Roles` a nivel de m√©todo

## üåê Endpoints Disponibles

### Base URL: `/analytics`

---

## 1. üìà An√°lisis de Ocupaci√≥n

### `GET /analytics/ocupacion`

Calcula m√©tricas de ocupaci√≥n hotelera (RevPAR, ADR, tasa de ocupaci√≥n) agrupadas por per√≠odos.

#### **Par√°metros de Query (FiltrosOcupacionDto):**

| Par√°metro | Tipo | Requerido | Descripci√≥n | Ejemplo |
|-----------|------|-----------|-------------|---------|
| `fechaInicio` | `string` | ‚ùå | Fecha de inicio (ISO 8601) | `2024-01-01` |
| `fechaFin` | `string` | ‚ùå | Fecha de fin (ISO 8601) | `2024-12-31` |
| `agruparPor` | `'d√≠a' \| 'semana' \| 'mes' \| 'a√±o'` | ‚ùå | Per√≠odo de agrupaci√≥n | `mes` |
| `tipoHabitacion` | `TiposHabitacion` | ‚ùå | Filtrar por tipo espec√≠fico | `SENCILLA` |

**Validaciones:**
- `@IsOptional()` y `@IsDateString()` para fechas
- `@IsOptional()` y `@IsEnum(['d√≠a', 'semana', 'mes', 'a√±o'])` para agrupaci√≥n
- `@IsOptional()` y `@IsEnum(TiposHabitacion)` para tipo de habitaci√≥n

#### **Ejemplo de Request:**
```
GET /analytics/ocupacion?fechaInicio=2024-01-01&fechaFin=2024-03-31&agruparPor=mes&tipoHabitacion=SENCILLA
```

#### **Respuesta (AnalisisOcupacionResponseDto):**

```typescript
interface AnalisisOcupacionResponseDto {
  ocupacionPorPeriodo: OcupacionPorPeriodoDto[];
  ocupacionPromedio: number;
  revparPromedio: number;
  adrPromedio: number;
}

interface OcupacionPorPeriodoDto {
  periodo: string;         // Fecha ISO del per√≠odo
  tasaOcupacion: number;   // Porcentaje de ocupaci√≥n
  revpar: number;          // Revenue Per Available Room
  adr: number;             // Average Daily Rate
  totalReservas: number;   // N√∫mero total de reservas
  ingresosTotales: number; // Ingresos totales del per√≠odo
}
```

#### **Ejemplo de Respuesta:**
```json
{
  "ocupacionPorPeriodo": [
    {
      "periodo": "2024-01-01T00:00:00.000Z",
      "tasaOcupacion": 85.5,
      "revpar": 38475.0,
      "adr": 45000,
      "totalReservas": 34,
      "ingresosTotales": 1530000
    }
  ],
  "ocupacionPromedio": 88.9,
  "revparPromedio": 40005.0,
  "adrPromedio": 45000
}
```

---

## 2. üåç An√°lisis Demogr√°fico de Hu√©spedes

### `GET /analytics/huespedes/demografia`

Analiza la distribuci√≥n demogr√°fica de hu√©spedes por nacionalidad con m√©tricas de ingresos.

#### **Par√°metros de Query (FiltrosAnalyticsDto):**

| Par√°metro | Tipo | Requerido | Descripci√≥n | Ejemplo |
|-----------|------|-----------|-------------|---------|
| `fechaInicio` | `string` | ‚ùå | Fecha de inicio | `2024-01-01` |
| `fechaFin` | `string` | ‚ùå | Fecha de fin | `2024-12-31` |
| `tipoHabitacion` | `TiposHabitacion` | ‚ùå | Filtrar por tipo habitaci√≥n | `SENCILLA` |
| `nacionalidades` | `string[]` | ‚ùå | Array de nacionalidades espec√≠ficas | `["Colombia", "Venezuela"]` |
| `paisesProcedencia` | `string[]` | ‚ùå | Array de pa√≠ses de procedencia | `["Colombia", "Venezuela"]` |
| `motivoViaje` | `MotivosViajes` | ‚ùå | Motivo espec√≠fico | `VACACIONES_RECREO_Y_OCIO` |
| `estadoReserva` | `EstadosReserva` | ‚ùå | Estado espec√≠fico | `FINALIZADO` |

**Validaciones:**
- `@IsOptional()` y `@IsDateString()` para fechas
- `@IsOptional()` y `@IsEnum()` para enums
- `@IsOptional()`, `@IsArray()` y `@IsString({ each: true })` para arrays

#### **Ejemplo de Request:**
```
GET /analytics/huespedes/demografia?fechaInicio=2024-01-01&fechaFin=2024-12-31&nacionalidades=Colombia,Venezuela
```

#### **Respuesta (DemografiaHuespedesDto[]):**

```typescript
interface DemografiaHuespedesDto {
  nacionalidad: string;
  cantidad: number;
  porcentaje: number;
  ingresos: number;
}
```

#### **Ejemplo de Respuesta:**
```json
[
  {
    "nacionalidad": "Colombia",
    "cantidad": 145,
    "porcentaje": 72.5,
    "ingresos": 6525000
  },
  {
    "nacionalidad": "Venezuela",
    "cantidad": 55,
    "porcentaje": 27.5,
    "ingresos": 2475000
  }
]
```

---

## 3. üó∫Ô∏è An√°lisis de Procedencia de Hu√©spedes

### `GET /analytics/huespedes/procedencia`

Analiza la procedencia geogr√°fica (pa√≠s y ciudad) de los hu√©spedes.

#### **Par√°metros de Query (FiltrosAnalyticsDto):**
*Mismos par√°metros que el endpoint de demograf√≠a*

#### **Ejemplo de Request:**
```
GET /analytics/huespedes/procedencia?fechaInicio=2024-01-01&fechaFin=2024-12-31&paisesProcedencia=Colombia
```

#### **Respuesta (ProcedenciaHuespedesDto[]):**

```typescript
interface ProcedenciaHuespedesDto {
  paisProcedencia: string;
  ciudadProcedencia: string;
  cantidad: number;
  porcentaje: number;
}
```

#### **Ejemplo de Respuesta:**
```json
[
  {
    "paisProcedencia": "Colombia",
    "ciudadProcedencia": "Bogot√°",
    "cantidad": 89,
    "porcentaje": 44.5
  },
  {
    "paisProcedencia": "Colombia",
    "ciudadProcedencia": "Medell√≠n",
    "cantidad": 56,
    "porcentaje": 28.0
  }
]
```

---

## 4. üè® An√°lisis de Rendimiento de Habitaciones

### `GET /analytics/habitaciones/rendimiento`

Analiza el rendimiento financiero y ocupacional por tipo de habitaci√≥n.

#### **Par√°metros de Query (FiltrosAnalyticsDto):**
*Mismos par√°metros que el endpoint de demograf√≠a*

#### **Ejemplo de Request:**
```
GET /analytics/habitaciones/rendimiento?fechaInicio=2024-01-01&fechaFin=2024-12-31&tipoHabitacion=SENCILLA
```

#### **Respuesta (RendimientoHabitacionDto[]):**

```typescript
interface RendimientoHabitacionDto {
  tipo: TiposHabitacion;
  totalHabitaciones: number;
  tasaOcupacionPromedio: number;
  ingresosTotales: number;
  precioPromedioNoche: number;
  revpar: number;
}
```

#### **Ejemplo de Respuesta:**
```json
[
  {
    "tipo": "SENCILLA",
    "totalHabitaciones": 15,
    "tasaOcupacionPromedio": 68.5,
    "ingresosTotales": 8500000,
    "precioPromedioNoche": 55000,
    "revpar": 37675
  }
]
```

---

## 5. ‚úàÔ∏è An√°lisis de Motivos de Viaje

### `GET /analytics/motivos-viaje`

Segmenta las reservas por motivos de viaje con duraci√≥n promedio de estancia.

#### **Par√°metros de Query (FiltrosAnalyticsDto):**
*Mismos par√°metros que el endpoint de demograf√≠a*

#### **Ejemplo de Request:**
```
GET /analytics/motivos-viaje?fechaInicio=2024-01-01&fechaFin=2024-12-31&motivoViaje=VACACIONES_RECREO_Y_OCIO
```

#### **Respuesta (MotivosViajeDto[]):**

```typescript
interface MotivosViajeDto {
  motivo: MotivosViajes;
  cantidad: number;
  porcentaje: number;
  duracionPromedioEstancia: number;
}
```

#### **Ejemplo de Respuesta:**
```json
[
  {
    "motivo": "VACACIONES_RECREO_Y_OCIO",
    "cantidad": 125,
    "porcentaje": 62.5,
    "duracionPromedioEstancia": 3.2
  },
  {
    "motivo": "NEGOCIOS_Y_MOTIVOS_PROFESIONALES",
    "cantidad": 75,
    "porcentaje": 37.5,
    "duracionPromedioEstancia": 1.8
  }
]
```

---

## 6. üîÆ Predicci√≥n de Ocupaci√≥n (Solo Administrador)

### `GET /analytics/forecast/ocupacion`

Genera predicciones de ocupaci√≥n futura basadas en patrones hist√≥ricos.

#### **Par√°metros de Query (ForecastParamsDto):**

| Par√°metro | Tipo | Requerido | Descripci√≥n | Ejemplo |
|-----------|------|-----------|-------------|---------|
| `fechaInicio` | `string` | ‚ùå | Fecha de inicio datos hist√≥ricos | `2024-01-01` |
| `fechaFin` | `string` | ‚ùå | Fecha de fin datos hist√≥ricos | `2024-12-31` |
| `periodosAdelante` | `number` | ‚úÖ | Per√≠odos a predecir (1-12) | `6` |
| `tipoPeriodo` | `'mes' \| 'semana'` | ‚úÖ | Tipo de per√≠odo | `mes` |

**Validaciones:**
- `@IsInt()` y `@Min(1)` para per√≠odos adelante
- `@IsEnum(['mes', 'semana'])` para tipo de per√≠odo

#### **Ejemplo de Request:**
```
GET /analytics/forecast/ocupacion?fechaInicio=2024-01-01&fechaFin=2024-12-31&periodosAdelante=6&tipoPeriodo=mes
```

#### **Respuesta (PrediccionOcupacionDto[]):**

```typescript
interface PrediccionOcupacionDto {
  periodo: string;
  ocupacionPredicida: number;
  nivelConfianza: number;
  ingresosPredichos: number;
}
```

#### **Ejemplo de Respuesta:**
```json
[
  {
    "periodo": "2025-01",
    "ocupacionPredicida": 78.2,
    "nivelConfianza": 85.5,
    "ingresosPredichos": 4250000
  }
]
```

---

## 7. üìä Dashboard Ejecutivo (Solo Administrador)

### `GET /analytics/dashboard`

Dashboard consolidado con KPIs principales y comparaciones temporales.

#### **Par√°metros de Query (FiltrosDashboardDto):**

| Par√°metro | Tipo | Requerido | Descripci√≥n | Ejemplo |
|-----------|------|-----------|-------------|---------|
| `fechaInicio` | `string` | ‚ùå | Fecha de inicio | `2024-01-01` |
| `fechaFin` | `string` | ‚ùå | Fecha de fin | `2024-12-31` |
| `incluirComparacion` | `boolean` | ‚ùå | Comparar con per√≠odo anterior | `true` |
| `topMercados` | `number` | ‚ùå | N√∫mero top mercados (3-10) | `5` |

**Validaciones:**
- `@Transform()` para boolean desde string
- `@IsInt()` y `@Min(3)` para top mercados

#### **Ejemplo de Request:**
```
GET /analytics/dashboard?fechaInicio=2024-01-01&fechaFin=2024-06-30&incluirComparacion=true&topMercados=5
```

#### **Respuesta (DashboardEjecutivoDto):**

```typescript
interface DashboardEjecutivoDto {
  ocupacionActual: number;
  revparActual: number;
  adrActual: number;
  ingresosPeriodo: number;
  topMercadosEmisores: DemografiaHuespedesDto[];
  distribucionMotivosViaje: MotivosViajeDto[];
  rendimientoHabitaciones: RendimientoHabitacionDto[];
  tasaHuespedesRecurrentes: number;
  comparacionPeriodoAnterior?: {
    ocupacionAnterior: number;
    revparAnterior: number;
    adrAnterior: number;
    ingresosAnteriores: number;
    cambioOcupacion: number;
    cambioRevpar: number;
    cambioAdr: number;
    cambioIngresos: number;
  };
}
```

#### **Ejemplo de Respuesta:**
```json
{
  "ocupacionActual": 75.8,
  "revparActual": 45000,
  "adrActual": 59500,
  "ingresosPeriodo": 12500000,
  "topMercadosEmisores": [
    {
      "nacionalidad": "Colombia",
      "cantidad": 145,
      "porcentaje": 72.5,
      "ingresos": 6525000
    }
  ],
  "distribucionMotivosViaje": [],
  "rendimientoHabitaciones": [],
  "tasaHuespedesRecurrentes": 18.5,
  "comparacionPeriodoAnterior": {
    "ocupacionAnterior": 68.2,
    "revparAnterior": 38000,
    "adrAnterior": 55700,
    "ingresosAnteriores": 10200000,
    "cambioOcupacion": 11.1,
    "cambioRevpar": 18.4,
    "cambioAdr": 6.8,
    "cambioIngresos": 22.5
  }
}
```

---

## üéØ Enums y Tipos Utilizados

### **TiposHabitacion**
```typescript
enum TiposHabitacion {
  SENCILLA = 'SENCILLA',
  DOBLE = 'DOBLE',
  TRIPLE = 'TRIPLE',
  MATRIMONIAL = 'MATRIMONIAL',
  FAMILIAR = 'FAMILIAR'
}
```

### **MotivosViajes**
```typescript
enum MotivosViajes {
  VACACIONES_RECREO_Y_OCIO = 'VACACIONES_RECREO_Y_OCIO',
  NEGOCIOS_Y_MOTIVOS_PROFESIONALES = 'NEGOCIOS_Y_MOTIVOS_PROFESIONALES',
  // ... otros valores seg√∫n @prisma/client
}
```

### **EstadosReserva**
```typescript
enum EstadosReserva {
  FINALIZADO = 'FINALIZADO',
  // ... otros valores seg√∫n @prisma/client
}
```

---

## üöÄ Ejemplos de Uso para Frontend

### 1. Dashboard Principal con KPIs
```typescript
// Obtener dashboard completo con comparaci√≥n
const response = await fetch('/analytics/dashboard?fechaInicio=2024-01-01&fechaFin=2024-12-31&incluirComparacion=true&topMercados=5', {
  headers: { 'Authorization': `Bearer ${token}` }
});
const dashboard = await response.json();

// Mostrar KPIs principales
console.log(`Ocupaci√≥n: ${dashboard.ocupacionActual}%`);
console.log(`RevPAR: $${dashboard.revparActual}`);
console.log(`Cambio vs anterior: ${dashboard.comparacionPeriodoAnterior?.cambioOcupacion}%`);
```

### 2. Gr√°fico de Ocupaci√≥n Mensual
```typescript
// Obtener datos de ocupaci√≥n por meses
const response = await fetch('/analytics/ocupacion?fechaInicio=2024-01-01&fechaFin=2024-12-31&agruparPor=mes');
const data = await response.json();

// Preparar datos para Chart.js
const chartData = {
  labels: data.ocupacionPorPeriodo.map(p => new Date(p.periodo).toLocaleString('es', { month: 'long' })),
  datasets: [{
    label: 'Tasa de Ocupaci√≥n (%)',
    data: data.ocupacionPorPeriodo.map(p => p.tasaOcupacion),
    backgroundColor: 'rgba(54, 162, 235, 0.2)'
  }]
};
```

### 3. An√°lisis de Mercados con Filtros
```typescript
// An√°lisis demogr√°fico espec√≠fico
const params = new URLSearchParams({
  fechaInicio: '2024-01-01',
  fechaFin: '2024-12-31',
  'nacionalidades[]': 'Colombia',
  'nacionalidades[]': 'Venezuela'
});

const response = await fetch(`/analytics/huespedes/demografia?${params}`);
const demografiaData = await response.json();

// Crear gr√°fico de distribuci√≥n
const pieChartData = demografiaData.map(item => ({
  label: item.nacionalidad,
  value: item.porcentaje
}));
```

### 4. Predicci√≥n de Ocupaci√≥n
```typescript
// Solo para administradores
const response = await fetch('/analytics/forecast/ocupacion?periodosAdelante=6&tipoPeriodo=mes');
const predicciones = await response.json();

// Mostrar tabla de predicciones
predicciones.forEach(pred => {
  console.log(`${pred.periodo}: ${pred.ocupacionPredicida}% (confianza: ${pred.nivelConfianza}%)`);
});
```

---

## üîß C√≥digos de Error Comunes

| C√≥digo | Descripci√≥n | Soluci√≥n |
|--------|-------------|----------|
| `400` | Par√°metros de fecha inv√°lidos | Usar formato ISO 8601: `YYYY-MM-DD` |
| `400` | Enum inv√°lido | Verificar valores exactos de enums Prisma |
| `400` | Rango de per√≠odos inv√°lido | `periodosAdelante` debe estar entre 1-12 |
| `401` | No autenticado | Incluir token Bearer v√°lido |
| `403` | Sin permisos | Verificar rol (some endpoints solo ADMIN) |
| `500` | Error de consulta SQL | Revisar logs del servidor |

---

## üìö Notas T√©cnicas

### **Performance y Optimizaci√≥n**
- **Consultas SQL Optimizadas**: Uso de `$queryRaw` con `DATE_TRUNC` para agrupaci√≥n
- **Consultas Paralelas**: Dashboard ejecuta m√∫ltiples consultas con `Promise.all()`
- **Conversi√≥n de BigInt**: Manejo correcto de tipos de datos PostgreSQL
- **√çndices**: Aprovecha √≠ndices en `fecha_inicio`, `habitacionId`, `huespedId`

### **Manejo de Fechas**
- **Timezone**: Todas las fechas en UTC
- **Formato**: ISO 8601 (`YYYY-MM-DD`)
- **Opcional**: Todos los filtros de fecha son opcionales
- **Conversi√≥n**: Frontend debe manejar conversi√≥n a timezone local

### **Validaciones**
- **Class-validator**: Decoradores de validaci√≥n en todos los DTOs
- **Transform**: Conversi√≥n autom√°tica de strings a tipos apropiados
- **Enum validation**: Validaci√≥n estricta contra enums de Prisma

### **Seguridad**
- **Autenticaci√≥n JWT**: Requerida en todos los endpoints
- **Autorizaci√≥n por Roles**: ADMINISTRADOR/CAJERO con restricciones espec√≠ficas
- **Sanitizaci√≥n**: Prisma protege contra SQL injection
- **Rate Limiting**: Considerar implementar para endpoints intensivos

---

## üìà M√©tricas de Negocio Calculadas

- **Tasa de Ocupaci√≥n**: `(Total Reservas / Total Habitaciones) √ó 100`
- **RevPAR**: `(Tasa Ocupaci√≥n / 100) √ó ADR`
- **ADR**: `Precio Promedio por Noche`
- **Tasa Hu√©spedes Recurrentes**: `(Hu√©spedes con >1 reserva / Total Hu√©spedes) √ó 100`
- **Factor Estacional**: `1 + sin(per√≠odo √ó œÄ √ó 2) √ó 0.15` (en predicciones)

---

## üß™ Testing

- **Cobertura**: 47 tests unitarios (22 controller + 25 service)
- **Mocks**: PrismaService completamente mockeado
- **Casos**: √âxito, error, datos vac√≠os, valores BigInt
- **Comando**: `npm test -- --testPathPattern=analytics`

---

## üîÑ Changelog vs README Anterior

- ‚úÖ **Corregidos**: 7 endpoints reales vs 4 ficticios
- ‚úÖ **DTOs Reales**: Basados en implementaci√≥n Prisma
- ‚úÖ **Par√°metros Correctos**: Todos opcionales, no requeridos
- ‚úÖ **Respuestas Reales**: Estructuras exactas del c√≥digo
- ‚úÖ **Permisos Precisos**: Diferenciaci√≥n ADMIN vs CAJERO
- ‚úÖ **Validaciones Reales**: Basadas en decoradores implementados